# 《UNIX环境高级编程》第三章 文件I/O 学习笔记

## 1. 文件描述符
   对内核而言，所有打开的文件都是通过文件描述符引用的。文件描述符是一个非负整数。当打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。当读写一个文件时，使用open和creat函数返回的文件描述符表示该文件，将其作为参数传递给read或write。
   在符合POSIX.1的程序中幻数0，1，2虽然已经被标准化，但是应当把它们替换成以下三个符号常量STDIN_FILENO，STDFILE_FILENO，STDERR_FILENO以提高可读性，这些常量都在头文件<unistd.h>中定义。
   文件描述符的变化范围是0~OPEN_MAX - 1。

## 函数open和openat
   使用这两个函数可以打开或创建一个文件。
​	#include <fcntl.h>
​	int open(const char *path, int oflag, ... /* mode_t mode */);
​	int openat(int fd, const char *path, int oflag, ... /* mode_t mode */);
   函数返回值：成功返回文件描述符，失败返回-1。
   上面两个函数最后的可变参数列表是在创建新文件是才会使用，函数原型中将这个参数放在注释中。
   path为要打开或创建的文件的名字，oflag为这个函数的多个选项，用一个或多个常量选项进行或运算构成oflag参数。
+ O_RDONLY 只读打开 0
+ O_WRONLY只写打开 1
+ O_RDWR 读写打开 2
+ O_EXEC 只执行打开
+ O_SEARCH 只搜索打开，应用于目录
**上面的5个常量必须指定一个且只能指定一个。**

**一下几个常量是可选的。**
+ O_APPEND 每次写时都追加到文件末尾。
+ O_CLOEXEC 把FD_CLOEXEC常量设置为文件描述符标志。
+ O_CREAT 若文件不存在则创建它，使用这个选项时，必须指定函数第四个参数mode，用来定义该文件的访问权限位。
+ O_DIRECTORY 如果path引用的不是目录，则出错。
+ O_EXCL 如果同时制定了O_CREAT并且该文件已经存在，则报错。可以用来测试文件是否存在，使得检测和创建文件成为一个原子操作。
+ O_NOCTTY 若path引用的是终端设备，则不将该终端分配作为此进程的控制终端。
+ O_NONBLOCK 如果path引用是一个FIFO，一个特殊块文件或者一个特殊字符文件，则此选项为文件的本次打开操作和后续I/O操作设置非阻塞方式。
+ O_SYNC 每次write等待物理I/O操作完成。
+ O_TRUNC 如果此文件存在，而且为只写或读写成功代开，则将其文件长度截断为0.
+ O_TTY_INIT 如果打开一个还未打开的终端设备，则设置非标准termios参数值，示器符合Signal UNIX Specification。
+ O_DSYNC 每次write要等待物理I/O操作完成，但是如果该操作并不影响刚读取的数据，则不需等待文件属性被更新。
+ O_RSYNC 是每一个以文件描述符作为参数进行read的操作等待，直至所有对文件统一部份挂起的写操作都完成。

   open和openat函数返回的文件描述符都是最小的未使用的文件描述符。这两个函数以fd参数来区分。
   1. 如果path是绝对路径名，则文件描述符被忽略，openat函数此时与open函数相同。
   2. 如果path是相对路径名，fd参数指出了相对路径名在文件系统中的开始地址，fd参数是通过打开相对路径名所在的目录来获取。
   3. 如果path制定了相对路径名，而且fd参数具有特殊值AT_FDCWD。在这种情况下，路径名在当前工作目录下获取。
关于open和openat函数的更多信息可以使用man命令来查看。
